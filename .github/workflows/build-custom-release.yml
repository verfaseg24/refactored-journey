name: Build Custom Release APK

on:
  push:
    tags:
      - 'v*'  # Запускается при создании тега типа v1.0.0
  workflow_dispatch:  # Можно запустить вручную

jobs:
  build:
    name: Build and Release APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version-file: .github/.java-version
          distribution: 'adopt'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.18.3'

      - name: Install NDK
        run: |
          echo "y" | sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;21.4.7075529"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create keystore directory
        run: mkdir -p $HOME/jenkins_static/com.duckduckgo.mobile.android/

      - name: Create dummy keystore (for debug build)
        run: |
          keytool -genkey -v -keystore $HOME/jenkins_static/com.duckduckgo.mobile.android/android \
            -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"

      - name: Create debug properties
        run: |
          cat > $HOME/jenkins_static/com.duckduckgo.mobile.android/ddg_android_debug_build.properties << EOF
          releaseKeyAlias=androiddebugkey
          releaseKeyPassword=android
          releaseStorePassword=android
          EOF

      - name: Build Release APK
        env:
          MALICIOUS_SITE_PROTECTION_AUTH_TOKEN: ${{ secrets.MALICIOUS_SITE_PROTECTION_AUTH_TOKEN }}
        run: ./gradlew assembleInternalRelease -Pforce-default-variant

      - name: Find APK
        id: find_apk
        run: |
          APK_PATH=$(find app/build/outputs/apk -name "*internal-release.apk" | head -n 1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK at: $APK_PATH"

      - name: Rename APK
        run: |
          cp ${{ steps.find_apk.outputs.apk_path }} custom-browser-${{ github.ref_name || 'latest' }}.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: custom-browser-${{ github.ref_name }}.apk
          body: |
            ## Кастомный браузер DuckDuckGo
            
            ### Изменения:
            - ✅ Поиск по умолчанию: Google
            - ✅ Автоматическая система прокси (SOCKS/HTTP/HTTPS)
            
            ### Установка:
            1. Скачайте APK файл
            2. Разрешите установку из неизвестных источников
            3. Установите приложение
            
            ### Технические детали:
            - Прокси загружаются из: https://github.com/verfaseg24/cuddly-octo-adventure/raw/main/valid_proxies.txt
            - Автоматическая проверка работоспособности прокси
            - Fallback на прямое подключение
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: custom-browser-apk
          path: custom-browser-${{ github.ref_name || 'latest' }}.apk

      - name: Cleanup secrets
        if: always()
        run: rm -rf "$HOME/jenkins_static/com.duckduckgo.mobile.android/"*.properties "$HOME/jenkins_static/com.duckduckgo.mobile.android/android"
