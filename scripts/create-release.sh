#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞

set -e

echo "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º—ã –≤ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞: –≠—Ç–æ –Ω–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
echo "üìå –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $CURRENT_VERSION"
echo ""

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, v1.0.0): " NEW_VERSION

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤–µ—Ä—Å–∏–∏
if [[ ! $NEW_VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: v1.0.0"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤–µ—Ä—Å–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
    echo "‚ùå –¢–µ–≥ $NEW_VERSION —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    exit 1
fi

echo ""
echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ $NEW_VERSION"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
if [[ -n $(git status -s) ]]; then
    echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
    git status -s
    echo ""
    read -p "–ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è? (y/n): " COMMIT_CHANGES
    
    if [[ $COMMIT_CHANGES == "y" ]]; then
        read -p "–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: " COMMIT_MESSAGE
        git add .
        git commit -m "$COMMIT_MESSAGE"
        echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã"
    else
        echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ. –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è."
        exit 1
    fi
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞
echo ""
echo "üè∑Ô∏è  –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ $NEW_VERSION..."
git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"

# –ü—É—à —Ç–µ–≥–∞
echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–≥–∞ –Ω–∞ GitHub..."
git push origin "$NEW_VERSION"

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
echo ""
echo "üì¶ GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:"
echo "   1. –°–æ–±–µ—Ä–µ—Ç APK"
echo "   2. –ü–æ–¥–ø–∏—à–µ—Ç –µ–≥–æ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å–µ–∫—Ä–µ—Ç—ã)"
echo "   3. –°–æ–∑–¥–∞—Å—Ç GitHub Release"
echo "   4. –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç APK –∫ —Ä–µ–ª–∏–∑—É"
echo ""
echo "üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏:"
echo "   https://github.com/$(git config --get remote.origin.url | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/actions"
echo ""
echo "üì• –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏ —Å–∫–∞—á–∞–π—Ç–µ APK:"
echo "   https://github.com/$(git config --get remote.origin.url | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/releases/tag/$NEW_VERSION"
